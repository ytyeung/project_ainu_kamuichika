{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 241,
   "metadata": {},
   "outputs": [],
   "source": [
    "from google import genai\n",
    "from google.genai import types\n",
    "import base64\n",
    "import json\n",
    "import os\n",
    "from dotenv import load_dotenv\n",
    "\n",
    "import unicodedata\n",
    "import re"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 242,
   "metadata": {},
   "outputs": [],
   "source": [
    "load_dotenv()\n",
    "project_name = os.getenv('PROJECT_NAME')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The story id, from 1 to 13 according to the 13 Ainu Kamuy Yukars translated by Chiri Yukie. The Yukar ID starts at 1. Chiri's Preface is 0."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 243,
   "metadata": {},
   "outputs": [],
   "source": [
    "start_at = 13\n",
    "end_at = 13"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 244,
   "metadata": {},
   "outputs": [],
   "source": [
    "system_instruction_prompt = \"\"\"You are a professional translator. You know Japanese, English and Chinese. You can translate Japanese into either Chinese or English.\"\"\"\n",
    "\n",
    "client = genai.Client(\n",
    "      vertexai=True,\n",
    "      project=project_name,\n",
    "      location=\"us-central1\",\n",
    ")\n",
    "\n",
    "model = \"gemini-2.0-flash-001\"\n",
    "\n",
    "generate_content_config = types.GenerateContentConfig(\n",
    "    temperature = 0,\n",
    "    top_p = 0,\n",
    "    max_output_tokens = 8192,\n",
    "    response_modalities = [\"TEXT\"],\n",
    "    safety_settings = [types.SafetySetting(\n",
    "      category=\"HARM_CATEGORY_HATE_SPEECH\",\n",
    "      threshold=\"OFF\"\n",
    "    ),types.SafetySetting(\n",
    "      category=\"HARM_CATEGORY_DANGEROUS_CONTENT\",\n",
    "      threshold=\"OFF\"\n",
    "    ),types.SafetySetting(\n",
    "      category=\"HARM_CATEGORY_SEXUALLY_EXPLICIT\",\n",
    "      threshold=\"OFF\"\n",
    "    ),types.SafetySetting(\n",
    "      category=\"HARM_CATEGORY_HARASSMENT\",\n",
    "      threshold=\"OFF\"\n",
    "    )],\n",
    "    system_instruction=[types.Part.from_text(text=system_instruction_prompt)],\n",
    "  )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 245,
   "metadata": {},
   "outputs": [],
   "source": [
    "poetic_translation_prompt = \"Translate the following text from Japanese to Chinese. The original text is a poem. Try to make the translation poetic but keep the original meanings. Display in Traditional Chinese.\"\n",
    "\n",
    "descriptive_translation_prompt = \"Translate the following text from Japanese to Chinese. Keep the original meanings. Display in Traditional Chinese.\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 246,
   "metadata": {},
   "outputs": [],
   "source": [
    "# read the content page of Japanese translation and get the Japanese translated title\n",
    "with open(\"Chiri_Japanese_Translation/content.txt\", \"r\", encoding=\"utf8\") as f:\n",
    "    japanese_content = f.read()\n",
    "    japanese_content = unicodedata.normalize('NFKC', japanese_content)\n",
    "\n",
    "\n",
    "s=re.split(r'\\n\\n', japanese_content)\n",
    "japanese_titles = re.split(r'\\n', s[1])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 247,
   "metadata": {},
   "outputs": [],
   "source": [
    "# read the content page of Ainu original text and get the original title\n",
    "with open(\"original_Ainu_text/content.txt\", \"r\", encoding=\"utf8\") as f:\n",
    "    ainu_content = f.read()\n",
    "    ainu_content = unicodedata.normalize('NFKC', ainu_content)\n",
    "\n",
    "\n",
    "s=re.split(r'\\n\\n', ainu_content)\n",
    "ainu_titles = re.split(r'\\n', s[1])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 248,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Read the markdown template for writing the Chinese translations to Markdown file\n",
    "\n",
    "#read in the template\n",
    "with open(\"templates/raw_output_md_template\", \"r\", encoding=\"utf8\") as f:\n",
    "    md_template = f.read()\n",
    "    md_template = unicodedata.normalize('NFKC', md_template)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 249,
   "metadata": {},
   "outputs": [],
   "source": [
    "def generate(client: genai.Client,generate_content_config :types.GenerateContentConfig,model :str, /,input_text :str, prompt :str):\n",
    "\n",
    "    text_full_prompt = text1 = types.Part.from_text(text=f\"{prompt}\\n\\n{input_text}\")\n",
    "\n",
    "    output = \"\"\n",
    "\n",
    "    contents = [\n",
    "      types.Content(\n",
    "        role=\"user\",\n",
    "        parts=[\n",
    "          text_full_prompt\n",
    "        ]\n",
    "      )\n",
    "    ]\n",
    "\n",
    "    for chunk in client.models.generate_content_stream(\n",
    "        model = model,\n",
    "        contents = contents,\n",
    "        config = generate_content_config,\n",
    "        ):\n",
    "        print(chunk.text, end=\"\")\n",
    "        output += chunk.text\n",
    "\n",
    "    return output\n",
    "\n",
    "def get_output_file_name_key(title :str):\n",
    "    # setup the output file name\n",
    "    s = title.split()\n",
    "    md_name_part = s[0]\n",
    "\n",
    "    name_2nd_part = \"\"\n",
    "\n",
    "    for text in s:\n",
    "        if text.startswith('“'):\n",
    "            name_2nd_part = text.replace('“', '').replace('”', '')\n",
    "        \n",
    "    md_name_part += \"_\" + name_2nd_part\n",
    "\n",
    "    return md_name_part\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "好的，這是一段將日文詩歌翻譯成繁體中文的嘗試，我會盡力在保留原意的同時，兼顧詩意：\n",
      "\n",
      "**沼貝自歌謠「托努佩卡 蘭蘭」**\n",
      "\n",
      "托努佩卡 蘭蘭\n",
      "\n",
      "烈日炎炎，灼我身旁，\n",
      "乾涸將盡，命不久長。\n",
      "「誰人賜水，解我乾渴，\n",
      "救我脫離，此般苦厄。\n",
      "水啊水啊！」哀聲泣訴，\n",
      "遙見海濱，一女緩步。\n",
      "背負竹簍，向我走來，\n",
      "無視哀鳴，漠然走開。\n",
      "見我可憐，\n",
      "「可憎沼貝，何苦喧嘩，\n",
      "擾人清靜，徒增笑話。」\n",
      "言罷足踏，碾碎貝殼，\n",
      "拋擲遠方，揚長而去。\n",
      "「痛哉苦哉，水啊水啊！」\n",
      "哀號未絕，又見一女，\n",
      "背負竹簍，自海濱來。\n",
      "我等呼號：「誰人慈悲，\n",
      "賜我甘霖，救我將死。\n",
      "痛哉苦哉，水啊水啊！」\n",
      "此女若神，容顏清麗，\n",
      "見我慘狀，駐足嘆息：\n",
      "「可憐沼貝，酷暑難耐，\n",
      "棲身之所，乾涸龜裂，\n",
      "渴求甘霖，何故遭難，\n",
      "莫非受人，踐踏欺凌？」\n",
      "輕柔拾起，聚攏一處，\n",
      "置於蕗葉，捧入清湖。\n",
      "清冽湖水，滋潤身軀，\n",
      "重獲生機，恢復元氣。\n",
      "方知二女，性情迥異，\n",
      "先來之女，狠心踐踏，\n",
      "乃是薩瑪雲庫爾之妹，\n",
      "後至之女，憐憫相助，\n",
      "乃是奧奇奇里姆伊之妹。\n",
      "薩瑪雲庫爾之妹，心懷惡念，\n",
      "致使粟田，枯萎凋零。\n",
      "奧奇奇里姆伊之妹，心懷善念，\n",
      "使其粟田，豐收盈倉。\n",
      "是年，奧奇奇里姆伊之妹，\n",
      "收穫頗豐，皆因我故。\n",
      "遂以沼貝之殼，摘取粟穗。\n",
      "自此之後，人間女子，\n",
      "採摘粟穗，皆用貝殼。\n",
      "\n",
      "一沼貝如是說。\n",
      "以下是將日文文本翻譯成繁體中文的結果：\n",
      "\n",
      "沼貝自唱的歌謠「托努佩卡 蘭蘭」\n",
      "\n",
      "托努佩卡 蘭蘭\n",
      "強烈的日光照射，我的棲身之處也\n",
      "乾涸了，我快要死了。\n",
      "「誰來給我水喝，\n",
      "救救我吧。水啊水啊」我們哭喊著，\n",
      "從遠方的海灘走來一位女子，\n",
      "背著竹簍。\n",
      "我們哭泣著，她從我們身旁經過，\n",
      "看見我們，\n",
      "說：「可笑的沼貝，可惡的沼貝，哭什麼\n",
      "吵吵鬧鬧的。」\n",
      "她踩踏我們，用腳尖踢開，連同貝殼一起踩碎，\n",
      "然後就往山裡去了。\n",
      "「好痛，好難受，水啊水啊。」我們哭喊著，\n",
      "從遠方的海灘又走來一位女子，\n",
      "背著竹簍。我們\n",
      "「誰來給我們水喝，救救我們吧，\n",
      "好痛，好難受，水啊水啊。」哭喊著。\n",
      "於是，那位姑娘，神一般美麗高貴，\n",
      "來到我們身邊，看見我們，\n",
      "說：「真可憐，天氣這麼熱，沼貝們的\n",
      "棲身之處都乾涸了，想要喝水，\n",
      "這是怎麼了呢？\n",
      "好像是被踩踏過一樣……」\n",
      "她一邊說著，一邊把我們都撿起來，\n",
      "放在蕗葉上，放進了清澈的湖裡。\n",
      "我們喝了清澈的冷水，完全恢復了元氣，\n",
      "變得非常健康。於是，我們開始\n",
      "探究那些女子的性情，\n",
      "發現先來，踩踏我的\n",
      "可憎的女子，壞女人是薩瑪雲庫爾的\n",
      "妹妹，而憐憫我們，\n",
      "幫助我們的年輕姑娘，溫柔賢淑的\n",
      "是奧基基里穆伊的妹妹。\n",
      "薩瑪雲庫爾的妹妹邪惡可憎，\n",
      "導致她的粟米田枯萎，而奧基基里穆伊的\n",
      "妹妹的粟米田則結實纍纍。\n",
      "那一年，奧基基里穆伊的妹妹大豐收。\n",
      "她知道這是因為我的緣故，\n",
      "就用沼貝的殼來摘粟米的穗。\n",
      "從那以後，每年，人類的女子們\n",
      "在摘粟米穗的時候，都會使用沼貝的殼。\n",
      "一隻沼貝這樣講述著。\n"
     ]
    }
   ],
   "source": [
    "# process the translation in batch mode\n",
    "\n",
    "for song_no in range(start_at, end_at + 1):\n",
    "    with open(f\"Chiri_Japanese_Translation/story_translation_{song_no}.txt\", \"r\", encoding=\"utf8\") as f:\n",
    "        japanese_story = f.read()\n",
    "        japanese_story = unicodedata.normalize('NFKC', japanese_story)\n",
    "\n",
    "        poetic_translation = generate(client,generate_content_config,model,input_text=japanese_story,prompt=poetic_translation_prompt)\n",
    "\n",
    "        descriptive_translation = generate(client,generate_content_config,model,input_text=japanese_story,prompt=descriptive_translation_prompt)\n",
    "\n",
    "        md_output = md_template.format(translated_language=\"Chinese\", ainu_title=ainu_titles[song_no - 1],\n",
    "                               poetic_prompt=poetic_translation_prompt, descriptive_prompt=descriptive_translation_prompt,\n",
    "                               japanese_title=japanese_titles[song_no], input_japanese = japanese_story,\n",
    "                               output_poetic=poetic_translation, output_descriptive=descriptive_translation)\n",
    "        \n",
    "        md_name_part = get_output_file_name_key(ainu_titles[song_no - 1])\n",
    "\n",
    "        with open(f\"LLM_prompts_and_raw_translations_main_content/Chinese_Translation/{song_no}_{md_name_part}_to_Chinese.md\", \"w\", encoding=\"utf8\") as f:\n",
    "            f.write(md_output)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "llama",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
